/*
 * 高速数学ライブラリ imas.c
 */
#include <math.h>

#define IMAS_PI 314

/* サイン */
short imas_sin[628]={0,2,5,7,10,12,15,17,20,23,25,28,30,33,35,38,40,43,45,48,50,53,55,58,60,63,65,68,70,73,75,78,80,82,85,87,90,92,94,97,99,102,104,106,109,111,113,115,118,120,122,124,127,129,131,133,135,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,181,183,185,187,188,190,192,194,195,197,198,200,202,203,205,206,208,209,211,212,214,215,216,218,219,220,222,223,224,225,226,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,242,243,244,245,245,246,247,247,248,249,249,250,250,251,251,252,252,253,253,253,254,254,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,254,254,254,253,253,253,252,252,251,251,250,250,249,249,248,248,247,246,246,245,244,243,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,225,224,223,222,220,219,218,217,215,214,212,211,209,208,206,205,203,202,200,199,197,195,194,192,190,189,187,185,183,182,180,178,176,174,172,171,169,167,165,163,161,159,157,155,153,151,149,146,144,142,140,138,136,134,131,129,127,125,123,120,118,116,114,111,109,107,104,102,100,97,95,92,90,88,85,83,80,78,76,73,71,68,66,63,61,58,56,53,51,48,46,43,41,38,36,33,31,28,25,23,20,18,15,13,10,8,5,2,0,-2,-4,-7,-9,-12,-14,-17,-20,-22,-25,-27,-30,-32,-35,-37,-40,-42,-45,-47,-50,-52,-55,-57,-60,-62,-65,-67,-70,-72,-75,-77,-80,-82,-84,-87,-89,-92,-94,-96,-99,-101,-104,-106,-108,-110,-113,-115,-117,-120,-122,-124,-126,-129,-131,-133,-135,-137,-139,-142,-144,-146,-148,-150,-152,-154,-156,-158,-160,-162,-164,-166,-168,-170,-172,-174,-176,-177,-179,-181,-183,-185,-186,-188,-190,-192,-193,-195,-197,-198,-200,-201,-203,-204,-206,-207,-209,-210,-212,-213,-215,-216,-217,-219,-220,-221,-223,-224,-225,-226,-227,-229,-230,-231,-232,-233,-234,-235,-236,-237,-238,-239,-240,-241,-241,-242,-243,-244,-245,-245,-246,-247,-247,-248,-249,-249,-250,-250,-251,-251,-252,-252,-253,-253,-253,-254,-254,-254,-254,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-254,-254,-254,-253,-253,-253,-252,-252,-251,-251,-251,-250,-249,-249,-248,-248,-247,-246,-246,-245,-244,-243,-243,-242,-241,-240,-239,-238,-237,-237,-236,-235,-233,-232,-231,-230,-229,-228,-227,-226,-224,-223,-222,-221,-219,-218,-217,-215,-214,-213,-211,-210,-208,-207,-205,-204,-202,-201,-199,-197,-196,-194,-192,-191,-189,-187,-185,-184,-182,-180,-178,-176,-175,-173,-171,-169,-167,-165,-163,-161,-159,-157,-155,-153,-151,-149,-147,-145,-143,-140,-138,-136,-134,-132,-130,-127,-125,-123,-121,-118,-116,-114,-112,-109,-107,-105,-102,-100,-98,-95,-93,-90,-88,-86,-83,-81,-78,-76,-73,-71,-69,-66,-64,-61,-59,-56,-54,-51,-49,-46,-44,-41,-39,-36,-33,-31,-28,-26,-23,-21,-18,-16,-13,-11,-8,-5,-3};

/* コサイン */
short imas_cos[628]={256,255,255,255,255,255,255,255,255,254,254,254,254,253,253,253,252,252,251,251,250,250,249,249,248,248,247,246,246,245,244,243,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,225,224,223,222,220,219,218,216,215,214,212,211,209,208,206,205,203,202,200,199,197,195,194,192,190,189,187,185,183,181,180,178,176,174,172,170,168,167,165,163,161,159,157,155,153,150,148,146,144,142,140,138,136,133,131,129,127,125,122,120,118,116,113,111,109,106,104,102,99,97,95,92,90,87,85,83,80,78,75,73,70,68,66,63,61,58,56,53,51,48,46,43,40,38,35,33,30,28,25,23,20,18,15,12,10,7,5,2,0,-2,-4,-7,-10,-12,-15,-17,-20,-22,-25,-27,-30,-32,-35,-38,-40,-43,-45,-48,-50,-53,-55,-58,-60,-63,-65,-68,-70,-73,-75,-77,-80,-82,-85,-87,-89,-92,-94,-97,-99,-101,-104,-106,-108,-111,-113,-115,-118,-120,-122,-124,-127,-129,-131,-133,-135,-137,-140,-142,-144,-146,-148,-150,-152,-154,-156,-158,-160,-162,-164,-166,-168,-170,-172,-174,-176,-178,-179,-181,-183,-185,-187,-188,-190,-192,-193,-195,-197,-198,-200,-201,-203,-205,-206,-208,-209,-211,-212,-213,-215,-216,-218,-219,-220,-221,-223,-224,-225,-226,-228,-229,-230,-231,-232,-233,-234,-235,-236,-237,-238,-239,-240,-241,-242,-242,-243,-244,-245,-245,-246,-247,-247,-248,-249,-249,-250,-250,-251,-251,-252,-252,-253,-253,-253,-254,-254,-254,-254,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-255,-254,-254,-254,-253,-253,-253,-252,-252,-251,-251,-250,-250,-249,-249,-248,-248,-247,-246,-246,-245,-244,-243,-243,-242,-241,-240,-239,-238,-237,-236,-235,-234,-233,-232,-231,-230,-229,-228,-227,-226,-224,-223,-222,-221,-219,-218,-217,-215,-214,-212,-211,-210,-208,-207,-205,-204,-202,-200,-199,-197,-196,-194,-192,-191,-189,-187,-185,-184,-182,-180,-178,-176,-174,-173,-171,-169,-167,-165,-163,-161,-159,-157,-155,-153,-151,-149,-147,-145,-142,-140,-138,-136,-134,-132,-129,-127,-125,-123,-121,-118,-116,-114,-111,-109,-107,-104,-102,-100,-97,-95,-93,-90,-88,-85,-83,-81,-78,-76,-73,-71,-68,-66,-63,-61,-58,-56,-53,-51,-48,-46,-43,-41,-38,-36,-33,-31,-28,-26,-23,-21,-18,-15,-13,-10,-8,-5,-3,0,1,4,7,9,12,14,17,19,22,24,27,30,32,35,37,40,42,45,47,50,52,55,57,60,62,65,67,70,72,75,77,79,82,84,87,89,92,94,96,99,101,103,106,108,110,113,115,117,119,122,124,126,128,131,133,135,137,139,141,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,175,177,179,181,183,184,186,188,190,191,193,195,196,198,200,201,203,204,206,207,209,210,212,213,215,216,217,219,220,221,223,224,225,226,227,229,230,231,232,233,234,235,236,237,238,239,240,241,241,242,243,244,245,245,246,247,247,248,249,249,250,250,251,251,252,252,253,253,253,254,254,254,254,255,255,255,255,255,255,255,255};

/* 内部関数 */
static float myatan2(int a, int b);
static float mysqrt(float x);

/* 2点の角度(ラジアン)を求める */
int vge_rad(int x1,int y1,int x2,int y2)
{
	float k=myatan2(x2-x1,y2-y1);
	return (int)(k*3.1415f/1.80f);
}

/* 2点の角度(度数)を求める */
int vge_kkd(int x1,int y1,int x2,int y2)
{
	return (int)myatan2(x2-x1,y2-y1);
}

/* kkdをradに変換 */
int vge_kkd2rad(int kkd)
{
	float k;
	while(kkd<0) kkd+=360;
	while(359<kkd) kkd-=360;
	k=(float)kkd;
	k*=3.1415f;
	k/=1.80f;
	while (627<k) k-=628;
	return (int)k;
}

/* radをkkdに変換 */
int vge_rad2kkd(int rad)
{
	float r;
	while(rad<0) rad+=628;
	while(627<rad) rad-=628;
	r=(float)rad;
	r*=1.80f;
	r/=3.1415f;
	while (359<r) r-=360;
	return (int)r;
}

/* アークタンジェント */
static float myatan2(int a, int b)
{
	float u;
	float ret;
	float v;
	float d;
	int c;

	if(a==0x80000000) a++;
	else if(a==0) a--;
	if(b==0x80000000) b++;
	else if(b==0) b--;

	if(a<0) {
		if(b<0) {
			a=-a;
			b=-b;
			return 270-(90-myatan2(a,b));
		} else {
			return 360-myatan2(-a,b);
		}
	} else if(b<0) {
		return 180-myatan2(a,-b);
	} else if(a>b) {
		return 90-myatan2(b,a);
	}

	u=(float)a/b;

	if(a*3>=b*2) {
		v=(mysqrt(1.0f+u*u)-1.0f)/u;
		return (float)(2.0*myatan2((int)(v*2000+0.5),2000));
	}

	ret=0.0f;
	v=u;
	d=99.0f;
	c=1;

	while(d>=0.1||d<=-0.1) {
		d=57.295778965948f*v/c;
		ret+=d;
		v*=u*u;
		c=(c<0?2:-2)-c;
	}
	return ret;
}

/* 平方根 */
static float mysqrt(float x)
{
	float s,last;

	if(x<=0.0f) {
		return 0.0f;
	}

	if(x>1) {
		s=x;
	} else {
		s=1;
	}

	do {
		last=s;
		s=(x/s+s)*0.5f;
	} while(s<last);

	return last;
}

static unsigned int seed; /* 乱数の種 */

/* 乱数初期化 */
void vge_rands()
{
	seed=0x12345678;
}

/* 乱数取得 */
int vge_rand()
{
	seed=seed*48828125+1;
	return seed & 0x7FFFFFFF;
}

/* 絶対値を求める */
int vge_abs(int n)
{
	if(n<0) {
		return -n;
	}
	return n;
}

/* SIN */
int vge_sin(int r)
{
	while(r<0) r+=628;
	while(627<r) r-=628;
	return imas_sin[r];
}

/* COS */
int vge_cos(int r)
{
	while(r<0) r+=628;
	while(627<r) r-=628;
	return imas_cos[r];
}
